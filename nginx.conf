# ============================================================
#  Nginx 配置 — File Station (Autoindex 美化方案)
#
#  ★ 请根据你的实际环境修改带 ★ 标记的行
#  ★ 宝塔用户：将本文件中的关键配置段合并到你的站点配置中即可
# ============================================================

server {
    listen       80;                               # ★ 修改为你的端口
    server_name  files.example.com;                # ★ 修改为你的域名或 IP

    # ★ 修改为你的网站根目录
    root /www/wwwroot/your-site;

    charset utf-8;

    # ===========================================================
    #  安全响应头
    # ===========================================================
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ===========================================================
    #  性能优化
    # ===========================================================
    sendfile    on;
    tcp_nopush  on;
    tcp_nodelay on;

    gzip on;
    gzip_types text/plain text/css application/javascript application/json image/svg+xml;
    gzip_min_length 1024;
    gzip_vary on;

    # ===========================================================
    #  核心：Autoindex + 主题注入
    # ===========================================================
    location / {
        autoindex             on;
        autoindex_exact_size  off;
        autoindex_localtime   on;

        add_before_body /___theme___/header.html;
        add_after_body  /___theme___/footer.html;
        ssi on;

        try_files $uri $uri/ =404;
    }

    # ===========================================================
    #  主题文件映射
    # ===========================================================
    location /___theme___/ {
        alias /www/wwwroot/your-site/.theme/;      # ★ 与 root 一致
        internal;
    }

    location = /___theme___/fs.js {
        alias /www/wwwroot/your-site/.theme/fs.js;  # ★ 与 root 一致
    }

    # ===========================================================
    #  安全：禁止访问隐藏目录和敏感文件
    # ===========================================================
    location ~ ^/(\.theme|\.user\.ini|\.htaccess|\.git|\.env|\.svn) {
        return 404;
    }

    # ===========================================================
    #  静态资源缓存
    # ===========================================================
    location ~* \.(gif|jpg|jpeg|png|bmp|swf|ico|webp|avif)$ {
        expires      30d;
        access_log   off;
    }

    location ~* \.(js|css)$ {
        expires      12h;
        access_log   off;
    }

    # ===========================================================
    #  Favicon — 避免 404 日志
    # ===========================================================
    location = /favicon.ico {
        log_not_found off;
        access_log    off;
        return 204;
    }

    # ===========================================================
    #  防刷（按需启用，详见 README.md）
    # ===========================================================
    #
    #  在 nginx.conf 的 http {} 块中添加：
    #    limit_req_zone  $binary_remote_addr zone=fs_req:10m  rate=10r/s;
    #    limit_conn_zone $binary_remote_addr zone=fs_conn:10m;
    #
    #  在 location / 中启用：
    #    limit_req  zone=fs_req burst=20 nodelay;
    #    limit_conn fs_conn 10;
    #    limit_rate 5m;
    #    limit_req_status  429;
    #    limit_conn_status 429;
}
